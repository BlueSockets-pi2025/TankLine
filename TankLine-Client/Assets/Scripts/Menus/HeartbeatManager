using System.Collections;
using UnityEngine;

public class HeartbeatManager : MonoBehaviour
{
    public static HeartbeatManager Instance { get; private set; }

    [Header("Settings")]
    public float heartbeatInterval = 5f; // secondes entre deux heartbeats

    private float timeSinceLastHeartbeat = 0f;
    private bool isLoggedIn = false; // Tu peux setter Ã§a depuis ton AuthController

    private string heartbeatUrl = "https://185.155.93.105:17008/api/auth/heartbeat" ; 

    private void Awake()
    {

        if (Instance != null && Instance != this) // to avoid multiple instances 
        {
            Destroy(gameObject);
            return;
        }

        Instance = this;
        DontDestroyOnLoad(gameObject);
    }

    private void Update()
    {
        if (!isLoggedIn)
            return;

        timeSinceLastHeartbeat += Time.deltaTime;

        if (timeSinceLastHeartbeat >= heartbeatInterval)
        {
            timeSinceLastHeartbeat = 0f;
            StartCoroutine(SendHeartbeat());
        }
    }

    private IEnumerator SendHeartbeat()
    {
        Debug.Log("Is Logged In: " + isLoggedIn);

        if (!isLoggedIn) 
        {
            Debug.LogWarning("User is not logged in. Heartbeat request not sent.");
            yield break;  
        }
        else 
        {
             Debug.LogWarning("USER IS LOGGED IN");
        }

        Debug.LogWarning("SEND HEARTBEAT");
        yield return SendRequestWithAutoRefresh(
            heartbeatUrl,  
            "POST",  
            new Dictionary<string, string> { { "Content-Type", "application/json" } },
            null,  
            onSuccess: (response) =>
            {
                Debug.LogWarning("Heartbeat SUCCESS");
            },
            onError: (response) =>
            {
                Debug.LogWarning("Heartbeat failed: " + response.error);
            }
        );

     }


    public void SetLoggedIn(bool loggedIn)
    {
        isLoggedIn = loggedIn;
    }
}
